<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="static/new.css">
  <title>Login - The Scratch Channel</title>
</head>
<body>
  <header>
    <h1 class="stroke-double">Login - The Scratch Channel</h1>
  </header>

  <main>
    <a id="link" href="#">Login With ScratchAuth</a>
  </main>

  <script>
    const link = document.getElementById('link');
    link.href = `https://auth.itinerary.eu.org/auth?redirect=${btoa(window.location.href)}&name=The%20Scratch%20Channel`;

    const url = new URLSearchParams(window.location.search);
    const code = url.get('privateCode');

    if (code) {
      (async () => {
        try {
          const res = await fetch(`https://auth-api.itinerary.eu.org/auth/verifyToken/${code}`);
          const data = await res.json();
          const username = data.username;
          localStorage.setItem('user', username);
        } catch (err) {
          console.error('Error verifying token:', err);
        }
      })();
    }
      const authResponse = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });

    const authData = await authResponse.json();
    if (!authResponse.ok) {
      alert(authData.error || 'Authentication failed');
      return;
    }

    localStorage.setItem('authCode', authData.authCode);
    alert('Login successful!');
    window.location.href = 'articles.html';
  } catch (err) {
    console.error('Login failed:', err);
    alert('Login failed');
  }
});
  </script>
</body>
</html>
